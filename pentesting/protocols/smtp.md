# SMTP

## About

<mark style="color:red;">**Simple Mail Transfer Protocol (SMTP)**</mark> is a <mark style="color:purple;">**protocol for sending emails**</mark> in an IP network. It can be used between an email client and an outgoing mail server or between two **SMTP** servers. **SMTP** is often combined with the **IMAP** or **POP3** protocols, which can fetch emails and send emails. In principle, it is a <mark style="color:purple;">**client-server-based protocol**</mark>. Commonly it's using <mark style="color:yellow;">**TCP/25**</mark> port for unencrypted **SMTP**, <mark style="color:yellow;">**TCP/465**</mark> for encrypted, <mark style="color:yellow;">**TCP/587**</mark> for **SMTP STARTLS** Encryption.

## SMTP Servers

**SMTP** servers play a crucial role in preventing spam by supporting **ESMTP** with **SMTP-Auth** for authorized user-based email sending. The <mark style="color:red;">**Mail User Agent (MUA)**</mark> converts emails into headers and bodies, uploading them to the **SMTP** server. A <mark style="color:red;">**Mail Transfer Agent (MTA)**</mark> checks email size and spam, storing it after validation. Occasionally, a <mark style="color:red;">**Mail Submission Agent (MSA)**</mark> or <mark style="color:red;">**Relay server**</mark> validates email origin to prevent Open Relay Attacks. The **MTA** then searches **DNS** for the recipient mail server's IP address.

```bash
MUA(Client) -> MSA(Submission Agent) -> MTA(Open Relay) -> MDA(Mail Delivery Agent) -> POP3/IMAP(Mailbox)
```

## SMTP Commands

### Connect

Usually to connect to SMTP server you could use just telnet and specify port.

```
telnet 13.13.13.13 25
```

### VRFY

<mark style="color:green;">**VRFY**</mark> command is used for **checking** if the username is valid by requesting SMTP Server

```bash
VRFY root
252 2.0.0 root
```

### EXPN

<mark style="color:green;">**EXPN**</mark> command is same as **VRFY**, but if you send it a <mark style="color:purple;">**distribution list**</mark>, it'll send back all users from it.

```bash
EXPN impostors-team
250 2.0.0 john@amogus.com
250 2.1.5 bob@amogus.com
```

### RCPT TO

<mark style="color:green;">**RCPT TO**</mark> command specifies the recipient. The more times you use it, the more recipients you could find.

```bash
RCPT TO:kate
550 5.1.1 kate... User unknown

RCPT TO:den
250 2.1.5 den... Recipient ok
```

## Microsoft 365

Sure here wouldn't be whole section about 365, but that's a common thing, so let's write here some **basic enum techniques.**

### 0365spray

<mark style="color:red;">**O365spray**</mark> is a <mark style="color:purple;">**tool**</mark> for **username enum and password spraying** attack at Microsoft 365&#x20;

#### Validate

```bash
python3 o365spray.py --validate --domain amogus.com
```

#### Username Enum

```bash
python3 o365spray.py --enum -U users.txt --domain amogus.com
```

#### Password Spraying

```bash
python3 o365spray.py --spray -U users.txt -p '1mp0st3r' --count 1 --lockout 1 --domain amogus.com
```

## Tips2Hack

1. <mark style="color:green;">**Nmap**</mark> - Open Relay

```bash
sudo nmap 13.13.13.13 -p25 --script smtp-open-relay -v
```

2. <mark style="color:green;">**Nmap**</mark> - SMTP all scripts enum

```bash
sudo nmap 13.13.13.13 -p25 -sV -sC --script smtp* -v
```

3. <mark style="color:green;">**DIG**</mark> - Mail Server enum

```bash
dig mx amogus.com | grep "MX" | grep -v ";"
```

4. <mark style="color:green;">**Host**</mark> Mail Server

```bash
host -t A mail.amogus.htb
```

5. <mark style="color:green;">**smtp-user-enum**</mark> script [**\[LINK\]**](https://github.com/pentestmonkey/smtp-user-enum)

```bash
smtp-user-enum -M RCPT -U userlist.txt -D amogus.com -t 13.13.13.13
```

6. <mark style="color:green;">**Hydra**</mark> - Password attacks

If you know user, as example _<mark style="color:purple;">"</mark><mark style="color:purple;">**den"**</mark>_, don't use just username, use it with **domain/email address**, like <mark style="color:purple;">**den@amogus.com**</mark>

```bash
hydra -L users.txt -p 'amogus' -f 13.13.13.13 pop3
```

7. <mark style="color:green;">**Swaks**</mark> - Send mail

```bash
swaks --from notifications@amogus.com --to impostors@amogus.com --header 'Subject: You have suspected of being impostors' --body 'Hi, our councel of spacemen chose by democratic voting that you are sus, so you have no other choice but to surrender and be ready for empty vastness of space. If you want to deny that, please join our chat here and explain your sus behaviour: https://impostor-chat-court.com' --server 13.13.13.13
```
