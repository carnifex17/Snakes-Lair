# SMB

**Server Message Block (SMB) is a client-server protocol that regulates access to files and entire directories and other network resources such as printers, routers, or interfaces released for the network.** The SMB protocol enables the client to communicate with other participants in the same network to access files or services shared with it on the network.

### Samba

**Samba is an alternative variant to the SMB server, called Samba, developed for Unix-based operating system.** Samba implements the Common Internet File System (CIFS) network protocol. CIFS is a "dialect" of SMB. In other words, CIFS is a very specific implementation of the SMB protocol, which in turn was created by Microsoft. Therefore, it usually is referred to as SMB / CIFS. However, CIFS is the extension of the SMB protocol.

* Samba server over TCP ports `137`, `138`, `139`, but CIFS uses TCP port `445` only. In a network,using Samba, each host participates in the same `workgroup`. A workgroup is a group name that identifies an arbitrary collection of computers and their resources on an SMB network.
* `smbstatus` command to see who, from which host, and which share the client is connected.

### Smbclient

**Connecting to the Share**

```bash
smbclient -N -L //13.13.13.13
```

**OR**

```bash
smbclient -U username \\\\13.13.13.13\\share
```

* `-N` is for **null session**, which is anonymous access without the input user/pass. And `-L` is to list all shares.
* For basic interaction with share, you would need only these commands:
  * `help` to have list of available commands
  * `ls` list
  * `get` download
  * `!command` user prefix ! before command to execute it locally

### RPCclient

**The **<mark style="color:red;">**Remote Procedure Call (RPC)**</mark>** is a concept and, therefore, also a central tool to realize operational and work-sharing structures in networks and client-server architectures. Other words, RPC is a mechanism for interaction between processes that are executed on different nodes in the network.** The communication process via RPC includes passing parameters and the return of a function value. Also RPC have Remote Invocation Descriptor or <mark style="color:red;">**RID**</mark>,which is a unique identifier assigned to each remote procedure call. It is used to keep track of and manage the execution of remote procedures.

* Connect to SMB server

```bash
rpcclient -U "" 10.129.14.128
```

With connected RPC client we could use many different functions as:

| Function                  | Description                                                       |
| ------------------------- | ----------------------------------------------------------------- |
| `srvinfo`                 | Server information                                                |
| `enumdomains`             | Enumerate all domains that are deployed in the network            |
| `querydominfo`            | Provides domain, server, and user information of deployed domains |
| `netshareenumall`         | Enumerates all available shares                                   |
| `netsharegetinfo <share>` | Provides information about a specific share                       |
| `enumdomusers`            | Enumerates all domain users                                       |
| `queryuser <RID>`         | Provides information about a specific user                        |
| `querygroup <RID>`        | Provides information about a specific group                       |

### Dangerous Settings

* `browseable = yes` - Allow listing available shares in the current share?
* `read only = no` - Forbid the creation and modification of files?
* `writable = yes` - Allow users to create and modify files?
* `guest ok = yes` - Allow connecting to the service without using a password?
* `enable privileges = yes` - Honor privileges assigned to specific SID?
* `create mask = 0777` - What permissions must be assigned to the newly created files?
* `directory mask = 0777` - What permissions must be assigned to the newly created directories?
* `logon script = script.sh` - What script needs to be executed on the user's login?
* `magic script = script.sh` - Which script should be executed when the script gets closed?
* `magic output = script.out` - Where the output of the magic script needs to be stored?

### Tips2Hack

1. Samba config location:

```bash
cat /etc/samba/smb.conf | grep -v "#\|\;"
```

2. To bruteforce RID using rpcclient to do active enum of users and groups you could use this command:

```bash
for i in $(seq 500 1100);do rpcclient -N -U "" 10.129.14.128 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done
```

3. Or for the same cause you could try yo use [samrdump.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/samrdump.py) script
4. You could use `SMBmap tool`

```bash
smbmap -H 13.13.13.13
```

5. You could use `CrackMapExec`

```bash
crackmapexec smb 13.13.13.13 --shares -u '' -p ''
```

6. You could use [enum4linux-ng](https://github.com/cddmp/enum4linux-ng)

```bash
./enum4linux-ng.py 13.13.13.13 -A
```

***
